%% AEAD (Authenticated Encryption with Associated Data) â€” Mermaid Cheat Sheet
%% Save as .mmd and preview with any Mermaid renderer.

%% ------------ FLOW OVERVIEW ------------
flowchart TB
  Title["ğŸ” AEAD: Authenticated Encryption with Associated Data"]
  
  subgraph Sender["ğŸ“¤ Sender (Encrypt)"]
    direction TB
    P["ğŸ“„ Plaintext P<br/>(secret data)"]
    AD["ğŸ“‹ Associated Data AD<br/>â€¢ NOT encrypted<br/>â€¢ IS authenticated<br/>â€¢ Examples: headers, userID"]
    K[("ğŸ”‘ Secret Key K<br/>(shared with receiver)")]
    N["ğŸ² Nonce N<br/>â€¢ Random/unique<br/>â€¢ Never reuse with same K"]
    
    P --> E
    AD --> E
    K -.->|encrypts & signs| E
    N --> E
    
    E["âš™ï¸ AEAD Encrypt"]
    
    E --> C["ğŸ”’ Ciphertext C<br/>(encrypted P)"]
    E --> TagCreate["ğŸ”§ Tag Creation:<br/>T = MAC with K, N, C, AD<br/><br/>Tag is a cryptographic hash that binds:<br/>â€¢ Ciphertext C<br/>â€¢ Associated Data AD<br/>â€¢ Nonce N<br/>â€¢ Secret Key K"]
    TagCreate --> T["âœ… Auth Tag T<br/>(proves integrity)"]
    
    SNote["ğŸ’¡ Key Point:<br/>Tag T = f with K, N, C, AD<br/>Change ANY input â†’ completely different tag<br/>Without K, attacker cannot create valid tag"]
  end

  C --> Channel
  T --> Channel
  N --> Channel
  AD --> Channel
  
  subgraph Channel["ğŸŒ Network / Untrusted Channel"]
    Bundle["ğŸ“¦ Sent Together:<br/>â€¢ Ciphertext C<br/>â€¢ Auth Tag T<br/>â€¢ Nonce N<br/>â€¢ Associated Data AD<br/><br/>âš ï¸ Attacker can see/modify"]
  end

  Channel --> Receiver
  
  subgraph Receiver["ğŸ“¥ Receiver (Verify & Decrypt)"]
    direction TB
    KR[("ğŸ”‘ Secret Key K<br/>(same as sender)")]
    
    RecompTag["ğŸ”§ Recompute Tag:<br/>T' = MAC with K, N, C, AD<br/><br/>Using received C, AD, N"]
    
    Compare["âš–ï¸ Compare Tags:<br/>Is T' = T?"]
    
    KR -.->|used to compute T'| RecompTag
    RecompTag --> Compare
    
    Compare -->|âœ… Match!| Valid["ğŸ‰ Success!<br/>â†’ Decrypt C â†’ P<br/><br/>âœ“ C, AD, N unchanged<br/>âœ“ Sender had key K<br/>âœ“ No tampering"]
    Compare -->|âŒ No Match!| Invalid["ğŸš« REJECT<br/>No plaintext revealed<br/><br/>Why tags differ:<br/>â€¢ C was modified â†’ different T'<br/>â€¢ AD was changed â†’ different T'<br/>â€¢ N was altered â†’ different T'<br/>â€¢ Wrong K used â†’ different T'<br/>â€¢ Attacker can't forge T without K"]
    
    RNote["ğŸ’¡ Key Point:<br/>Receiver recomputes tag T' using same inputs<br/>If T' â‰  T, something changed or wrong key<br/>Attacker without K cannot create matching tag"]
  end

  %% Styling
  style Sender stroke:#1976d2,stroke-width:2px
  style Channel stroke:#f57c00,stroke-width:2px
  style Receiver stroke:#388e3c,stroke-width:2px
  style Title fill:none,stroke:none,font-size:16px
  style Valid stroke:#2e7d32,stroke-width:2px
  style Invalid stroke:#c62828,stroke-width:2px
  style T stroke:#f9a825,stroke-width:2px
  style SNote stroke:#9e9e9e,stroke-width:1px
  style RNote stroke:#9e9e9e,stroke-width:1px

  %% Notes
  %% - Confidentiality: P is hidden inside C.
  %% - Integrity & Authenticity: T binds (C, AD, N) to K; tampering causes verify failure.
  %% - AD is authenticated but not encrypted (visible headers/metadata).
  %% - N must NEVER repeat with the same K. Reuse can break security catastrophically.

  %% AT-A-GLANCE
  %% â€¢ AEAD = Authenticated Encryption with Associated Data
  %% â€¢ Protects two things at once:
  %%     1) Confidentiality (encrypts P into C)
  %%     2) Integrity/Authenticity (T proves C+AD+N come from someone with K)
  %% â€¢ Associated Data (AD):
  %%     - Not encrypted (visible), but authenticated (tamper-evident)
  %%     - Examples: headers, user/account IDs, API version, timestamps
  %% â€¢ Nonce/IV (N):
  %%     - Unique per (K) to prevent reuse attacks
  %% â€¢ Typical algorithms:
  %%     - AES-GCM, ChaCha20-Poly1305