%% Widget + CAS + Webhook — Flowchart
flowchart TD
  B["Browser (Host Page)"]
  W["Address Widget (iframe)"]
  S["Supplier API + DB"]
  C["CAS (Canonical Address Service)"]
  F["Federate (IdP)"]

  B -->|"0) Load sandboxed widget\nCSP/origin allowlist"| W
  W -->|"1) Normalize + createAddress\n(AEAD or TLS 1.3)"| C
  C -->|"2) address_id (success)"| W
  C -->|"3) JWS webhook {supplier_id, address_id}"| S
  S -->|"Persist address_ref only (no plaintext)"| S
  S -->|"4) Short-lived view token (via host page)"| W
  W -->|"5) TLS GET view(address_id, token)"| C
  C -->|"Render plaintext inside iframe"| W
  S -->|"6) Client assertion → access token (for CAS)"| F
  F -->|"Scoped token, S verifies webhooks via CAS JWKS (kid rotation)"| S
