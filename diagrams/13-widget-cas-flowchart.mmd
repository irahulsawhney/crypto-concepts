%% Widget + CAS + Webhook — Flowchart
%% Widget + CAS + Webhook — Sequence Diagram
sequenceDiagram
  participant B as Browser (Host Page)
  participant W as Address Widget (iframe)
  participant S as Supplier API + DB
  participant C as CAS (Canonical Address Service)
  participant F as Federate (IdP)

  B->>W: 0) Load sandboxed widget (CSP/origin allowlist)
  W->>C: 1) Normalize + createAddress (AEAD or TLS 1.3)
  C-->>W: 2) address_id (success)
  C-->>S: 3) JWS webhook {supplier_id, address_id}
  S->>S: Persist address_ref only (no plaintext)
  S-->>W: 4) Short-lived view token (via host page)
  W->>C: 5) TLS GET view(address_id, token)
  C-->>W: Render plaintext inside iframe
  S->>F: 6) Client assertion → access token (for CAS)
  F-->>S: Scoped token, S verifies webhooks via CAS JWKS (kid rotation)
